<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>O Chat</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <!-- Estilos personalizados -->
  <link href="styles.css" rel="stylesheet">
  <link rel="shortcut icon" href="./img/imagem2.jpeg" />

  <style>

#colorPanel {
  position: fixed!important;right: 15px;bottom: 75px !important;border-radius: 16px;box-shadow: 0 14px 32px rgba(15, 23, 42, 0.35);padding: 14px;display: none; z-index: 100;
  background: linear-gradient(145deg, #ffffff 0%, #f6f8ff 100%);border: 1px solid #e4eaf3;
  transition: opacity 0.2s ease, transform 0.15s ease;opacity: 0;transform: translateY(10px);width: 290px;max-height: 200px;overflow-y: auto;}
#colorPanel.show {opacity: 1;transform: translateY(0);}
.color-grid {display: grid;grid-template-columns: repeat(5, 1fr);gap: 6px;}
.color-box {width: 32px;height: 32px;border-radius: 10px;cursor: pointer;border: 2px solid transparent;transition: transform 0.15s ease, border 0.2s, box-shadow 0.2s;}
.color-box:hover {transform: scale(1.1);border-color: #d3c5fa5e;box-shadow: 0 6px 14px rgba(15, 23, 42, 0.2);}
.color-box {position: relative;display: flex;align-items: center;justify-content: center;}
.color-check {color: white;font-size: 20px;font-weight: bold;display: none;}
.color-box.selected .color-check {display: block;}

/* Zoom quando a cor √© selecionada */
.color-box.selected {
  transform: scale(2.2);
  transition: transform 0.15s ease;
  border: 2px solid #ffffffcc; /* opcional: borda branca suave */
  box-shadow: 0 0 6px rgba(0,0,0,0.3);
  z-index: 10;
}
/* Manter anima√ß√£o suave mesmo quando hover existe */
.color-box {transition: transform 0.15s ease, box-shadow 0.2s ease;}
.color-box:hover {transform: perspective(200px) rotateX(6deg);}

  </style>
</head>

<body>
<!-- üîπ NAVBAR -->
<!-- üîπ NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm fixed-top chat-navbar">
  <div class="container position-relative d-flex align-items-center">

    <!-- LOGO -->
    <div class="">
      <img src="img/imagem3.png" style="width:82px; height:62px" alt="logo">
      <!---<a class="navbar-brand" href="#">ChatDF</a>--->
    </div>

    <!-- BOT√ÉO ‚ò∞ -->
    <button class="navbar-toggler order-2 ms-auto ms-lg-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav"
      aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- MENU (SEM userArea AQUI) -->
    <div class="collapse navbar-collapse order-3 order-lg-2 justify-content-end" id="navbarNav">
      
      <ul class="navbar-nav align-items-center">
         <li class="nav-item">
          <a class="nav-link" href="./index.html">Inicio</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Quem Somos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Contato</a>
        </li>
      </ul>
    </div>

    <!-- USU√ÅRIO (FORA DO MENU ‚Äî √öNICO userArea) -->
    <div id="userArea" class="user-fixed-area ms-3 ms-lg-auto order-1 order-lg-3"></div>

  </div>
</nav>

<script>
  // Garante que o menu comece fechado ao carregar a p√°gina
  document.addEventListener("DOMContentLoaded", () => {
    const navbarNav = document.getElementById("navbarNav");
    const toggler = document.querySelector(".navbar-toggler");
    if (navbarNav?.classList.contains("show")) {
      navbarNav.classList.remove("show");
    }
    if (toggler) {
      toggler.setAttribute("aria-expanded", "false");
    }
  });
</script>


<!-- T√≠tulo da Sala -->
<div id="salaTitulo" style="margin-top: 80px; text-align: center; font-weight: bold;">Carregando sala...</div>
<!--  Mensagens -->
<div id="chat-container" class="container-fluid"></div>
<!--  Campo de envio -->
<div id="message-input-area">
  <div class="attachment-wrapper">
    <button id="attachBtn" title="Anexar" class="btn-attach" aria-expanded="false">
      <i class="bi bi-paperclip"></i>
    </button>
    <div id="attachmentPanel" class="attachment-panel">
      <div class="attachment-grid">
        <button class="attachment-item" data-action="gallery">
          <span class="attachment-icon icon-gallery"><i class="bi bi-image"></i></span>
          <span class="attachment-label">Galeria</span>
        </button>
        <button class="attachment-item" data-action="camera">
          <span class="attachment-icon icon-camera"><i class="bi bi-camera-fill"></i></span>
          <span class="attachment-label">C√¢mera</span>
        </button>
        <button class="attachment-item" data-action="location">
          <span class="attachment-icon icon-location"><i class="bi bi-geo-alt-fill"></i></span>
          <span class="attachment-label">Localiza√ß√£o</span>
        </button>
        <button class="attachment-item" data-action="contact">
          <span class="attachment-icon icon-contact"><i class="bi bi-person-badge-fill"></i></span>
          <span class="attachment-label">Contato</span>
        </button>
        <button class="attachment-item" data-action="documento">
          <span class="attachment-icon icon-document"><i class="bi bi-file-earmark-text"></i></span>
          <span class="attachment-label">Documento</span>
        </button>
        <button class="attachment-item" data-action="audio">
          <span class="attachment-icon icon-audio"><i class="bi bi-headphones"></i></span>
          <span class="attachment-label">√Åudio</span>
        </button>
        <button class="attachment-item" data-action="poll">
          <span class="attachment-icon icon-poll"><i class="bi bi-bar-chart-line-fill"></i></span>
          <span class="attachment-label">Enquete</span>
        </button>
        <button class="attachment-item" data-action="event">
          <span class="attachment-icon icon-event"><i class="bi bi-calendar-event-fill"></i></span>
          <span class="attachment-label">Evento</span>
        </button>
        <button class="attachment-item" id="stickerBtn" data-action="stickers">
          <span class="attachment-icon icon-sticker"><img src="img/sorrir.png" alt="Figurinhas" width="24" height="24"></span>
          <span class="attachment-label">Figurinhas</span>
        </button>
        <button class="attachment-item" id="colorBtn" data-action="color">
          <span class="attachment-icon icon-color"><i class="bi bi-palette-fill"></i></span>
          <span class="attachment-label">Cor do texto</span>
        </button>
        <button class="attachment-item" data-action="ai">
          <span class="attachment-icon icon-ai"><i class="bi bi-stars"></i></span>
          <span class="attachment-label">Imagens de IA</span>
        </button>
      </div>
    </div>
  </div>
  <button id="emojiBtn" title="Adicionar emoji"><i class="bi bi-emoji-smile"></i></button>
<div id="replyPreview" class="reply-preview" style="display:none;"></div>
<textarea id="messageInput" class="message-input" placeholder="Digite sua mensagem..." rows="1"></textarea>
  <button id="sendBtn" title="Enviar"><i class="bi bi-send-fill"></i></button>
</div>
<!-- üîπ Painel de Figurinhas -->
<div id="stickerPanel"><div id="stickerList"></div></div>
<!-- üé® Painel de Cores -->
<div id="colorPanel">
  <div class="fw-bold mb-2 text-center">Escolha uma cor</div>
  <div class="color-grid" id="dynamicColors"></div>
</div>

<!-- üîπ Toast -->
<div id="toast"></div>

<!-- üîπ Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>



<script type="module">
/* ======================================================
   üöÄ NOVA PALETA DE CORES (DIN√ÇMICA / SALVA NO FIREBASE)
====================================================== */

import { auth, db } from "./js/firebase-config.js";
import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { showToast } from "./js/ui.js";

let selectedColor = "#000000";   // ‚≠ê SEMPRE COME√áA COM PRETO
let colorLocked = false;

const messageInput = document.getElementById("messageInput");
messageInput.style.color = "#000000";   // ‚≠ê GARANTE QUE SEMPRE INICIA PRETO

const colorBtn = document.getElementById("colorBtn");
const colorPanel = document.getElementById("colorPanel");
const grid = document.getElementById("dynamicColors");
const attachBtn = document.getElementById("attachBtn");
const attachmentPanel = document.getElementById("attachmentPanel");

const attachmentActions = {
  gallery: () => showToast("Galeria em breve."),
  camera: () => showToast("C√¢mera em breve."),
  location: () => showToast("Localiza√ß√£o em breve."),
  contact: () => showToast("Contato em breve."),
  documento: () => showToast("Documento em breve."),
  audio: () => showToast("√Åudio em breve."),
  poll: () => showToast("Enquete em breve."),
  event: () => showToast("Evento em breve."),
  ai: () => showToast("Imagens de IA em breve.")
};

const closeAttachmentPanel = () => {
  if (!attachmentPanel) return;
  attachmentPanel.classList.remove("show");
  attachBtn?.setAttribute("aria-expanded", "false");
};

const toggleAttachmentPanel = () => {
  if (!attachmentPanel) return;
  const open = attachmentPanel.classList.toggle("show");
  attachBtn?.setAttribute("aria-expanded", open ? "true" : "false");
};

// Paleta de cores fixa
const palette = ["#003366","#0066cc","#336699","#142952","#0055ff","#000066","#006666","#00cccc","#669999","#00ccff"," #666699","#339966","#194d33",
"#751aff","#a64dff","#4d0099","#339933","#9966ff","#006600","#003300","#009933","#990099","#ff1aff","#cc0099","#669900"," #b3b300","#ffcc00","#806600",
"#ff9933","#b35900","#ff6600","#b30000","#660033","#ff0080","#ac7339","#604020","#cc9900"," #661400","#cc0000","#990033","#663300","#666666", 
 
];

// Gerar paleta no painel
palette.forEach(color => {

  const box = document.createElement("div");
  box.classList.add("color-box");
  box.style.backgroundColor = color;
  box.dataset.color = color;

  // ‚≠ê √çCONE ‚úî DA COR SELECIONADA
  const check = document.createElement("span");
  check.classList.add("color-check");
  check.textContent = "‚úî";

  box.appendChild(check);
  grid.appendChild(box);
});

/* ============================================
   üî• 1. Carregar cor do Firebase no LOGIN
============================================ */
auth.onAuthStateChanged(async (user) => {
  if (!user) return;

  // ‚≠ê SEMPRE VOLTA PARA PRETO ANTES DE CARREGAR COR DO FIREBASE
  selectedColor = "#000000";
  messageInput.style.color = "#000000";

  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

if (snap.exists() && snap.data().chatColor) {

    selectedColor = snap.data().chatColor;
    messageInput.style.color = selectedColor;

    // üî• S√≥ bloqueia se a cor N√ÉO for preto
    if (selectedColor !== "#000000") {
        colorLocked = true;
    } else {
        colorLocked = false;
    }

    // Atualizar √≠cone ‚úî visualmente
    document.querySelectorAll(".color-box").forEach(b => {
        if (b.dataset.color === selectedColor) {
            b.classList.add("selected");
        } else {
            b.classList.remove("selected");
        }
    });
}
  else {
    // Nenhuma cor salva ‚Üí usu√°rio pode escolher
    colorLocked = false;
  }
});

/* ============================================
   üî• RESET GERAL DA PALETA AO SAIR DA CONTA
============================================ */
window.addEventListener("resetColorPicker", () => {

  // RESET das vari√°veis
  selectedColor = "#000000";
  colorLocked = false;

  // RESET da cor no input
  messageInput.style.color = "#000000";

  // Remove sele√ß√£o visual
  document.querySelectorAll(".color-box").forEach(b => {
    b.classList.remove("selected");
    b.style.opacity = "1";
  });

  console.log("üé® Paleta resetada ap√≥s logout");
});

/* ============================================
   üî• 2. Escolher cor (SE N√ÉO estiver travado)
============================================ */
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("color-box")) {

    // ‚ùå J√° escolheu e est√° logado ‚Üí n√£o permite
    if (colorLocked) {
      showToast("Voc√™ j√° escolheu uma cor!.");
      return;
    }

    const color = e.target.dataset.color;
    selectedColor = color;
    messageInput.style.color = color;

    // ‚≠ê MARCAR ‚úî VISUAL NA COR ESCOLHIDA
    document.querySelectorAll(".color-box").forEach(b => b.classList.remove("selected"));
    e.target.classList.add("selected");

    const user = auth.currentUser;
    if (user) {
      await setDoc(doc(db, "users", user.uid), {
        chatColor: color
      }, { merge: true });
    }

    colorLocked = true;

    colorPanel.classList.remove("show");
    setTimeout(() => (colorPanel.style.display = "none"), 150);
  }

  // Fechar ao clicar fora
  if (!colorPanel.contains(e.target) && !colorBtn.contains(e.target)) {
    colorPanel.classList.remove("show");
    setTimeout(() => (colorPanel.style.display = "none"), 150);
  }
});

// Abrir painel
colorBtn.addEventListener("click", () => {
  const open = colorPanel.classList.contains("show");
  if (open) {
    colorPanel.classList.remove("show");
    setTimeout(() => (colorPanel.style.display = "none"), 150);
  } else {
    colorPanel.style.display = "block";
    setTimeout(() => colorPanel.classList.add("show"), 10);
  }
});

// Fun√ß√£o usada pelo messages.js
window.getSelectedColor = () => selectedColor;

/* ============================================
   üìé Painel de anexos estilo WhatsApp
============================================ */
attachBtn?.addEventListener("click", (e) => {
  e.stopPropagation();
  toggleAttachmentPanel();
});

attachmentPanel?.addEventListener("click", (e) => {
  const item = e.target.closest(".attachment-item");
  if (!item) return;
  closeAttachmentPanel();
  const action = item.dataset.action;
  const handler = attachmentActions[action];
  if (handler) handler();
});

document.addEventListener("click", (e) => {
  if (
    attachmentPanel?.classList.contains("show") &&
    !attachmentPanel.contains(e.target) &&
    !attachBtn?.contains(e.target)
  ) {
    closeAttachmentPanel();
  }
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") closeAttachmentPanel();
});

</script>




</body>
</html>
